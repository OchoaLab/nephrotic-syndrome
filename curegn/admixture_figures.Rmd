---
title: "CureGN admixture results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(popkin)
library(gdata)
```

# admixture plot for manuscript
```{r}
# covar file contains all individuals before excluding KO0939 and KO1059
# need all samples to match with ADMIXTURE output Q
data_curegn = read.table("/datacommons/ochoalab/curegn/merge_tgp/admixture/curegn_covar_diseasesubtype.txt", header = TRUE) 
# get id's for SSNS-SRNS
curegn_ssns_srns <- read_tsv( '/datacommons/ochoalab/curegn/patient-data.txt.gz' ) %>% filter(is.na(ssns_srns) ==FALSE)
table(curegn_ssns_srns$ssns_srns)
# get id's for NS
curegn_ns <- read_tsv( '/datacommons/ochoalab/curegn/patient-data.txt.gz' ) %>% filter(ns == TRUE)
table(curegn_ns$ns)

# merge data with TGP
data_tgp <- read_tsv( '/datacommons/ochoalab/ssns_gwas/imputed/patient-data.txt.gz', col_types = 'cccccdciiii' ) %>% 
  filter(dataset == "tgp") %>% 
  select(id, sex, race, ancestry, diagnosis) %>% mutate(diagnosis = "FALSE") %>% 
  mutate(race = ifelse(race == "Hispanic", "Other",  race)) %>% select(-ancestry)
data <- gdata::combine(data_curegn %>% select(id, race), data_tgp %>% select(id, race)) %>% 
  mutate(source = str_replace_all(source, "data_| %>% select\\(id, race\\)", ""))

# read admixture Q matrix:
admix_outQ <- read_table("/datacommons/ochoalab/curegn/merge_tgp/admixture/curegn_tgp_merge_maf10.5.Q", col_names = FALSE) 
names(admix_outQ) <- 1:5

# add race and id to Q matrix
admix_race = cbind(admix_outQ, data$id, data$race, data$source) %>% 
  dplyr::rename(id = `data$id`, race = `data$race`, data_source = `data$source`) %>% 
  mutate( `race` = as.factor(`race`))

# arrange by datasource/race
admix_arrange = admix_race %>% arrange(race, data_source) %>% 
  mutate(race = as.character(race), data_source = as.character(data_source), race_source = paste0(race, ":", data_source))

```

# filter major ancestry by 80%, SAS by 50%
# arrange individuals by each ancestry subgroup separately
```{r fig.width=8, fig.height=3}
AFR = admix_arrange %>% dplyr::filter(`1` > 0.8 & race == "Black") %>% 
  arrange(-`1`)
AFR_admix = admix_arrange %>% dplyr::filter(`1` <= 0.8 & race == "Black")  %>% 
  arrange(-`1`)
EUR = admix_arrange %>% dplyr::filter(`4` > 0.8 & race == "White")  %>% 
  arrange(-`4`)
EUR_admix = admix_arrange %>% dplyr::filter(`4` <= 0.8 & race == "White") %>% 
  arrange(-`4`)
EAS = admix_arrange %>% dplyr::filter(`3` > 0.8 & race == "Asian") %>% 
  arrange(-`3`)
SAS = admix_arrange %>% dplyr::filter(`5` > 0.5 & race == "Asian") %>% 
  arrange(-`5`)
EAS_admix = admix_arrange %>% dplyr::filter(`3` <= 0.8 & race == "Asian") %>% 
  filter(!id %in% SAS$id)
SAS_admix = admix_arrange %>% dplyr::filter(`5` <= 0.5 & race == "Asian") %>% 
  filter(!id %in% EAS$id)
# in SAS shouldn't be in EAS_admix
# in EAS shouldn't be in SAS_admix
Asian_admix = gdata::combine(EAS_admix, SAS_admix) %>% distinct(id, .keep_all = TRUE) %>% select(-source) %>% 
  rename(`1` = X1, `2` = X2, `3` = X3, `4` = X4, `5` = X5) %>% 
  arrange(-`5`)
Other =  admix_arrange %>% filter(race == "Other") %>% 
  arrange(-`2`)
```

Figure (A) CureGN + TGP
# split groups by ancestry and data source (curegn/tgp)
```{r fig.width=18, fig.height=6}
admix_plot_source = combine(AFR, AFR_admix, EUR, EUR_admix, SAS, EAS, Asian_admix, Other) %>%
  rename(African = X1, European = X4, 'South Asian' = X5, 'East Asian' = X3, 'Native American' = X2, ancestry = source) %>% 
  arrange(ancestry) %>% 
  mutate(ancestry = as.character(ancestry), new_label = as.character(paste0(ancestry,":",data_source))) %>% 
  arrange(match(new_label, c("AFR:curegn", "AFR:tgp", "AFR_admix:curegn", "AFR_admix:tgp",
                             "EUR:curegn", "EUR:tgp", "EUR_admix:curegn", 
                             "SAS:curegn", "SAS:tgp", "Asian_admix:curegn", "Asian_admix:tgp",
                             "EAS:curegn", "EAS:tgp", 
                             "Other:curegn", "Other:tgp"))) %>% 
  select(African, European, 'South Asian','East Asian', 'Native American', everything()) %>% arrange(new_label) %>% 
  # remove the new individuals
  filter(!id %in% c("KO0939", "KO1059"))
table(admix_plot_source$new_label, admix_plot_source$ancestry)
table(admix_plot_source$ancestry)
table(admix_plot_source$data_source)
plot_admix( admix_plot_source[,1:5], labs = admix_plot_source$new_label, labs_cex = 0.6, labs_las =1, leg_width = 0.1,
            labs_line = 2, xlab_line = 0.7, leg_cex = 0.8, labs_even = TRUE)
```
Figure (B)
# cleaned up admixture plot after 80% filter for AFR and EUR and 50% filter for SAS
# remove TGP
# filter for NS only
```{r fig.width=18, fig.height=6}
admix_plot = gdata::combine(AFR, AFR_admix, EUR, EUR_admix, SAS, EAS, Asian_admix, Other) %>%
  rename(African = X1, European = X4, 'South Asian' = X5, 'East Asian' = X3, 'Native American' = X2,
         ancestry = source) %>% arrange(ancestry) %>% 
  mutate(ancestry = as.character(ancestry)) %>% 
  select(African, European, 'South Asian','East Asian', 'Native American', everything()) %>% 
  # filter out the two individuals
  filter(!id %in% c("KO0939", "KO1059")) %>% 
  # remove TGP
  filter(data_source == "curegn") %>%  
  filter(id %in% curegn_ns$id)

plot_admix( admix_plot[,1:5], labs = admix_plot$ancestry, labs_cex = 0.9, labs_las =1, leg_width = 0.1,
            labs_line = 2, xlab_line = 0.7, leg_cex = 0.8, labs_even = TRUE)
```

Figure (C)
# cleaned up admixture plot after 80% filter for AFR and EUR and 50% filter for SAS
# remove TGP
# filter for SSNS & SRNS only
```{r fig.width=18, fig.height=6}
admix_plot = gdata::combine(AFR, AFR_admix, EUR, EUR_admix, SAS, EAS, Asian_admix, Other) %>%
  rename(African = X1, European = X4, 'South Asian' = X5, 'East Asian' = X3, 'Native American' = X2,
         ancestry = source) %>% arrange(ancestry) %>% 
  mutate(ancestry = as.character(ancestry)) %>% 
  select(African, European, 'South Asian','East Asian', 'Native American', everything()) %>% 
  # filter out the two individuals
  filter(!id %in% c("KO0939", "KO1059")) %>% 
  # remove TGP
  filter(data_source == "curegn") %>%  
  filter(id %in% curegn_ssns_srns$id)

plot_admix( admix_plot[,1:5], labs = admix_plot$ancestry, labs_cex = 0.9, labs_las =1, leg_width = 0.1,
            labs_line = 2, xlab_line = 0.7, leg_cex = 0.8, labs_even = TRUE)
```
