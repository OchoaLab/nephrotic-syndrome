# SSNS + TGP merged analysis with allele frequencies/likelihood ratio ratio per ancestry

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(BEDMatrix)
library(genio)
library(qqman)
```

```{r}
name <- '/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_gwas_maf'
bim <- read_bim( name )
bim %>% group_by(id) %>% filter(n()>1)
```

## remove duplicate ID's from ssns
```{r}
bim_id = bim %>% group_by(id) %>% filter(n()>1) %>% pull(id) 

ind_remove = c()
for (id in unique(bim_id)) {
  
  ind = grep(id, rownames(X))
  x_temp = X[ind,]
  print(mean(x_temp[1,] == x_temp[2,], na.rm = TRUE))
  if (mean(x_temp[1,] == x_temp[2,], na.rm = TRUE) > 0.99) {
    ind_remove = c(ind_remove, ind[2])
  } else {
    ind_remove = c(ind_remove, ind)
  }
}

X <- X[ -ind_remove, ]
bim <- bim[ -ind_remove, ]
write_plink( "ssns_gwas_maf_dedup", X, bim, data$fam )
```

## write SSNS control IDs into text file for AF test

```{r}
name <- '/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge'
merge = read_plink(name)
fam = merge$fam
merge$bim
ssns_pheno = read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/pheno_excelmerge.csv", sep = ",", header = TRUE)

ssns_pheno_w = ssns_pheno %>% filter(RACE == "White" & DIAGNOSIS == "Control") %>% pull(AcquisitionNumber)
ssns_fam_w = subset(fam, id %in% ssns_pheno_w) 
fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_merge_white_control.txt")
writeLines(paste0(ssns_fam_w$fam, " ", ssns_fam_w$id), fileConn)
close(fileConn)

ssns_pheno_b = ssns_pheno %>% filter(RACE == "Black" & DIAGNOSIS == "Control") %>% pull(AcquisitionNumber)
ssns_fam_b = subset(fam, id %in% ssns_pheno_b) 
fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_merge_black_control.txt")
writeLines(paste0(ssns_fam_b$fam, " ", ssns_fam_b$id), fileConn)
close(fileConn)

# ssns_pheno_a = ssns_pheno %>% filter(RACE == "Asian" & DIAGNOSIS == "Control") %>% pull(AcquisitionNumber)
# ssns_fam_a = subset(fam, id %in% ssns_pheno_a) 
# fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_merge_asian_control.txt")
# writeLines(paste0(ssns_fam_a$fam, " ", ssns_fam_a$id), fileConn)
# close(fileConn)
### south asians extracted from admixture analysis
```

## write tgp ancestry into text files
```{r}
AFR = c('MSL', 'YRI', "ESN", "GWD", "LWK", "ACB", "ASW")
EUR = c('CEU', 'GBR', 'IBS', 'TSI', 'FIN')
SAS = c('PJL', 'GIH', 'ITU', 'STU', 'BEB')

tgp_w = fam[which(fam$fam %in% EUR),]
fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_white.txt")
writeLines(paste0(tgp_w$fam, " ", tgp_w$id), fileConn)
close(fileConn)

tgp_sa = fam[which(fam$fam %in% SAS),]
fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_sa.txt")
writeLines(paste0(tgp_sa$fam, " ", tgp_sa$id), fileConn)
close(fileConn)

tgp_b = fam[which(fam$fam %in% AFR),]
fileConn<-file("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_black.txt")
writeLines(paste0(tgp_b$fam, " ", tgp_b$id), fileConn)
close(fileConn)
```

## Run with plink:
time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep ssns_maf_black --freq --out ssns_control_black #449
time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep ssns_maf_white.txt --freq --out ssns_control_white #278
time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep ssns_maf_sa.txt --freq --out ssns_control_sa #591

time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep tgp_sa.txt --freq --out tgp_sa #489
time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep tgp_white.txt --freq --out tgp_white #503
time plink2 --bfile /datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/ssns_tpg_merge --keep tgp_black.txt --freq --out tgp_black #661

## Read plink output files
```{r}
afreq_ssns_b <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_control_black.afreq", sep = "\t")
colnames(afreq_ssns_b) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")

afreq_ssns_w <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_control_white.afreq", sep = "\t")
colnames(afreq_ssns_w) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")

afreq_ssns_a <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/ssns_control_sa.afreq", sep = "\t")
colnames(afreq_ssns_a) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")

tgp_asian <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_sa.afreq", sep = "\t")
colnames(tgp_asian) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")

tgp_white <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_white.afreq", sep = "\t")
colnames(tgp_white) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")

tgp_black <- read.table("/datacommons/ochoalab/ssns_gwas/nephrotic.syndrome.gwas_proprocessing_202205/allele_freq/tgp_black.afreq", sep = "\t")
colnames(tgp_black) = c("CHROM", "ID", "REF", "ALT", "ALT_FREQS", "OBS_CT")
```


```{r}
plot(afreq_ssns_a$ALT_FREQS, tgp_asian$ALT_FREQS, xlab="ssns_control_southasians N = 591", ylab="tgp_southasians N = 489", main = "Group: South Asian", pch='.')
plot(afreq_ssns_w$ALT_FREQS, tgp_white$ALT_FREQS, xlab="ssns_control_white N = 278", ylab="tgp_white N = 503",  main = "Group: White", pch='.')
plot(afreq_ssns_b$ALT_FREQS, tgp_black$ALT_FREQS, xlab="ssns_control_black N = 449", ylab="tgp_black N = 661",  main = "Group: Black", pch='.')
```

## Identify ref/alt alleles

```{r}
comp <- function(x) chartr("ATGC","TACG",x)
afreq_ssns_b_comp = afreq_ssns_b[which(afreq_ssns_b$REF == comp(afreq_ssns_b$ALT)),]
tgp_black_comp = tgp_black[which(afreq_ssns_b$REF == comp(afreq_ssns_b$ALT)),]

afreq_ssns_w_comp = afreq_ssns_w[which(afreq_ssns_w$REF == comp(afreq_ssns_w$ALT)),]
tgp_white_comp = tgp_white[which(afreq_ssns_w$REF == comp(afreq_ssns_w$ALT)),]

afreq_ssns_a_comp = afreq_ssns_a[which(afreq_ssns_a$REF == comp(afreq_ssns_a$ALT)),]
tgp_asian_comp = tgp_asian[which(afreq_ssns_a$REF == comp(afreq_ssns_a$ALT)),]
```

```{r}
plot(afreq_ssns_a_comp$ALT_FREQS, tgp_asian_comp$ALT_FREQS, xlab="ssns_control_southasians N = 591", ylab="tgp_southasians N = 489", main = "ref == comp(alt) Group: South Asian", pch='.')
plot(afreq_ssns_w_comp$ALT_FREQS, tgp_white_comp$ALT_FREQS, xlab="ssns_control_white N = 278", ylab="tgp_white N = 503",  main = "ref == comp(alt) Group: White", pch='.')
plot(afreq_ssns_b_comp$ALT_FREQS, tgp_black_comp$ALT_FREQS, xlab="ssns_control_black N = 449", ylab="tgp_black N = 661",  main = "ref == comp(alt) Group: Black", pch='.')
```

# AF test for all ancestry combined (df = 3)
```{r}
ssns_b = afreq_ssns_b %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_b = tgp_black %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_a = afreq_ssns_a %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_a = tgp_asian %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_w = afreq_ssns_w %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_w = tgp_white %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))

# define function input
x1 = ssns_b$alt_allele_count
n1 = ssns_b$OBS_CT 
x2 = tgp_b$alt_allele_count 
n2 = tgp_b$OBS_CT 
x3 = ssns_a$alt_allele_count
n3 = ssns_a$OBS_CT
x4 = tgp_a$alt_allele_count
n4 = tgp_a$OBS_CT
x5 = ssns_w$alt_allele_count
n5 = ssns_w$OBS_CT
x6 = tgp_w$alt_allele_count
n6 = tgp_w$OBS_CT

output_p = likelihoodratio_3(x1, n1, x2, n2, x3, n3, x4, n4, x5, n5, x6, n6)
# p-values for ssns p data
#output_all = likelihoodratio(x1, n1, x2, n2, 3)
hist(output_p, breaks = 50, main = "p-vals likelihood ratio test (all ancestry)")
qq(output_p, main = "QQ-plot for all ancestry")
```


## ref == comp(alt)
```{r}
## define variables (P data)
ssns_b = afreq_ssns_b_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_b = tgp_black_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_a = afreq_ssns_a_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_a = tgp_asian_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_w = afreq_ssns_w_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_w = tgp_white_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))

# define function input
x1 = ssns_b$alt_allele_count
n1 = ssns_b$OBS_CT 
x2 = tgp_b$alt_allele_count 
n2 = tgp_b$OBS_CT 
x3 = ssns_a$alt_allele_count
n3 = ssns_a$OBS_CT
x4 = tgp_a$alt_allele_count
n4 = tgp_a$OBS_CT
x5 = ssns_w$alt_allele_count
n5 = ssns_w$OBS_CT
x6 = tgp_w$alt_allele_count
n6 = tgp_w$OBS_CT

output_comp_p = likelihoodratio_3(x1, n1, x2, n2, x3, n3, x4, n4, x5, n5, x6, n6)
hist(output_comp_p, breaks = 50, main = "p-vals likelihood ratio test (all ancestry)")
qq(output_comp_p, main = "QQ-plot for all ancestry")

# compute input variables for ssns (1-p data)
ssns_bf = afreq_ssns_b_comp %>% mutate(alt_allele_count = as.integer(round((1-ALT_FREQS) * OBS_CT)))
tgp_bf = tgp_black_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_af = afreq_ssns_a_comp %>% mutate(alt_allele_count = as.integer(round((1-ALT_FREQS) * OBS_CT)))
tgp_af = tgp_asian_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_wf = afreq_ssns_w_comp %>% mutate(alt_allele_count = as.integer(round((1-ALT_FREQS) * OBS_CT)))
tgp_wf = tgp_white_comp %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))

# subset SNPs in original P version
tgp_bf = tgp_bf %>% filter(ID %in% tgp_b$ID)
ssns_bf = ssns_bf %>% filter(ID %in% ssns_b$ID)
tgp_af = tgp_af %>% filter(ID %in% tgp_a$ID)
ssns_af = ssns_af %>% filter(ID %in% ssns_a$ID)
tgp_wf = tgp_wf %>% filter(ID %in% tgp_w$ID)
ssns_wf = ssns_wf %>% filter(ID %in% ssns_w$ID)

# define function input
x1 = ssns_bf$alt_allele_count
n1 = ssns_bf$OBS_CT 
x2 = tgp_bf$alt_allele_count 
n2 = tgp_bf$OBS_CT 
x3 = ssns_af$alt_allele_count
n3 = ssns_af$OBS_CT
x4 = tgp_af$alt_allele_count
n4 = tgp_af$OBS_CT
x5 = ssns_wf$alt_allele_count
n5 = ssns_wf$OBS_CT
x6 = tgp_wf$alt_allele_count
n6 = tgp_wf$OBS_CT

output_comp_1_p = likelihoodratio_3(x1, n1, x2, n2, x3, n3, x4, n4, x5, n5, x6, n6)
hist(output_comp_1_p, breaks = 50, main = "p-vals likelihood ratio test (all ancestry)")
qq(output_comp_1_p, main = "QQ-plot for all ancestry")

output_all_snp_B = cbind(tgp_bf$ID, tgp_bf$ALT_FREQS, ssns_bf$ALT_FREQS ,output_comp_1_p, output_comp_p) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, 1, 0)),
         flip = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         both_notsig = as.factor(ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         category = ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, "remove",
                           ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, "flip",
                                  ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) < as.numeric(output_comp_1_p), "both_notsig_flip", 
                                         ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) > as.numeric(output_comp_1_p), "both_notsig_keep", "keep"))))) %>% mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))

output_all_snp_B$category <- factor(output_all_snp_B$category, levels = c("keep", "alt_freq_0", "flip", "remove", "both_notsig_keep", "both_notsig_flip"))
table(output_all_snp_B$category)
ggplot(output_all_snp_B %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref == comp(alt)) likelihood ratio test; Black ancestry; cutoff 1e-6') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))


output_all_snp_A = cbind(tgp_af$ID, tgp_af$ALT_FREQS, ssns_af$ALT_FREQS ,output_comp_1_p, output_comp_p) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, 1, 0)),
         flip = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         both_notsig = as.factor(ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         category = ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, "remove",
                           ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, "flip",
                                 ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) < as.numeric(output_comp_1_p), "both_notsig_flip", 
                                         ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) > as.numeric(output_comp_1_p), "both_notsig_keep", "keep")))))  %>% 
  mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))
output_all_snp_A$category <- factor(output_all_snp_A$category, levels = c("keep", "alt_freq_0", "flip", "remove","both_notsig_keep", "both_notsig_flip"))
table(output_all_snp_A$category)
ggplot(output_all_snp_A %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref == comp(alt)) likelihood ratio test; South Asian ancestry; cutoff 1e-6') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))

output_all_snp_W = cbind(tgp_wf$ID, tgp_wf$ALT_FREQS, ssns_wf$ALT_FREQS ,output_comp_1_p, output_comp_p) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, 1, 0)),
         flip = as.factor(ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         both_notsig = as.factor(ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6, 1, 0)),
         category = ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) < 1e-6, "remove",
                           ifelse(as.numeric(output_comp_p) < 1e-6 & as.numeric(output_comp_1_p) > 1e-6, "flip",
                                 ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) < as.numeric(output_comp_1_p), "both_notsig_flip", 
                                         ifelse(as.numeric(output_comp_p) > 1e-6 & as.numeric(output_comp_1_p) > 1e-6 & as.numeric(output_comp_p) > as.numeric(output_comp_1_p), "both_notsig_keep", "keep")))))%>% 
  mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))
output_all_snp_W$category <- factor(output_all_snp_W$category, levels = c("keep", "alt_freq_0", "flip", "remove", "both_notsig_keep", "both_notsig_flip"))
table(output_all_snp_W$category)

ggplot(output_all_snp_W %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref == comp(alt)) likelihood ratio test; White ancestry; cutoff 1e-6') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))

```

## Gather 'remove' list  (priority over flip)
```{r}
# removal from ref != comp(alt)
afreq_ssns_b_ = afreq_ssns_b[which(afreq_ssns_b$REF != comp(afreq_ssns_b$ALT)),]
tgp_black_ = tgp_black[which(afreq_ssns_b$REF != comp(afreq_ssns_b$ALT)),]
afreq_ssns_w_ = afreq_ssns_w[which(afreq_ssns_w$REF != comp(afreq_ssns_w$ALT)),]
tgp_white_ = tgp_white[which(afreq_ssns_w$REF != comp(afreq_ssns_w$ALT)),]
afreq_ssns_a_ = afreq_ssns_a[which(afreq_ssns_a$REF != comp(afreq_ssns_a$ALT)),]
tgp_asian_ = tgp_asian[which(afreq_ssns_a$REF != comp(afreq_ssns_a$ALT)),]

## Black ancestry
ssns_b = afreq_ssns_b_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_b = tgp_black_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_a = afreq_ssns_a_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_a = tgp_asian_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
ssns_w = afreq_ssns_w_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))
tgp_w = tgp_white_ %>% mutate(alt_allele_count = as.integer(round(ALT_FREQS * OBS_CT)))

# define function input
x1 = ssns_b$alt_allele_count
n1 = ssns_b$OBS_CT 
x2 = tgp_b$alt_allele_count 
n2 = tgp_b$OBS_CT 
x3 = ssns_a$alt_allele_count
n3 = ssns_a$OBS_CT
x4 = tgp_a$alt_allele_count
n4 = tgp_a$OBS_CT
x5 = ssns_w$alt_allele_count
n5 = ssns_w$OBS_CT
x6 = tgp_w$alt_allele_count
n6 = tgp_w$OBS_CT

# p-values for ssns p data
output_ref = likelihoodratio_3(x1, n1, x2, n2, x3, n3, x4, n4, x5, n5, x6, n6)
remove_snp = cbind(tgp_b$ID, output_ref) %>% as.data.frame() %>% filter(as.numeric(output_ref) < 1e-10) %>% pull(V1)
hist(output_ref, breaks = 50, main = "p-vals likelihood ratio test (all ancestry)")
qq(output_ref, main = "QQ-plot for all ancestry")


# plot removal snps from ref!=comp(alt)
remove_snp_B = cbind(tgp_b$ID, tgp_b$ALT_FREQS, ssns_b$ALT_FREQS, output_ref) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_ref) < 1e-10, 1, 0)),
         category = ifelse(as.numeric(output_ref) < 1e-10 , "remove", "keep")) %>% 
  mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))
remove_snp_B$category <- factor(remove_snp_B$category, levels = c("keep", "alt_freq_0", "remove"))
table(remove_snp_B$category)
ggplot(remove_snp_B %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref != comp(alt)) likelihood ratio test; Black ancestry; cutoff 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "darkgreen"))

remove_snp_A = cbind(tgp_a$ID, tgp_a$ALT_FREQS, ssns_a$ALT_FREQS, output_ref) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_ref) < 1e-10, 1, 0)),
         category = ifelse(as.numeric(output_ref) < 1e-10, "remove", "keep")) %>% 
  mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))
remove_snp_A$category <- factor(remove_snp_A$category, levels = c("keep", "alt_freq_0", "remove"))
table(remove_snp_A$category)
ggplot(remove_snp_A %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref != comp(alt)) likelihood ratio test; South Asian ancestry; cutoff 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "darkgreen"))

remove_snp_W = cbind(tgp_w$ID, tgp_w$ALT_FREQS, ssns_w$ALT_FREQS, output_ref) %>% 
  as.data.frame() %>% rename(ID = V1, tgp_alt_freq = V2, ssns_alt_freq = V3) %>% 
  mutate(remove = as.factor(ifelse(as.numeric(output_ref) < 1e-10, 1, 0)),
         category = ifelse(as.numeric(output_ref) < 1e-10, "remove", "keep")) %>% 
  mutate(category = ifelse(is.na(category) == TRUE, "alt_freq_0", category))
remove_snp_W$category <- factor(remove_snp_W$category, levels = c("keep", "alt_freq_0", "remove"))
table(remove_snp_W$category)
ggplot(remove_snp_W %>% filter(category != "alt_freq_0") %>% arrange(category), aes(x=as.numeric(ssns_alt_freq), y=as.numeric(tgp_alt_freq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('(ref != comp(alt)) likelihood ratio test; White ancestry; cutoff 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "darkgreen"))

# removal from ref == comp(alt)
remove_snpID = output_all_snp_B %>% filter(remove == 1) %>% pull(ID)
combine_removeID = unique(c(remove_snp, remove_snpID))

```

## plot original AF plots with identified remove and flip snps
```{r}
afreq_ssns_b = afreq_ssns_b %>% select(ID, ssns_altfreq = ALT_FREQS)
afreq_ssns_w = afreq_ssns_w %>% select(ID, ssns_altfreq = ALT_FREQS)
afreq_ssns_a = afreq_ssns_a %>% select(ID, ssns_altfreq = ALT_FREQS)
tgp_asian = tgp_asian %>% select(ID, tgp_altfreq = ALT_FREQS)
tgp_white = tgp_white %>% select(ID, tgp_altfreq = ALT_FREQS)
tgp_black  = tgp_black %>% select(ID, tgp_altfreq = ALT_FREQS)

# flip list, notsig list, NA list
final_flipID = output_all_snp_B %>% filter(flip == 1) %>% pull(ID)
notsig_all_keep = output_all_snp_B %>% filter(category == "both_notsig_keep") %>% pull(ID)
notsig_all_flip = output_all_snp_B %>% filter(category == "both_notsig_flip") %>% pull(ID)
NA_list = unique(c(output_all_snp_B %>% filter(category == "alt_freq_0") %>% pull(ID), remove_snp_W %>% filter(category == "alt_freq_0") %>% pull(ID)))

merge_AF_B = merge(afreq_ssns_b, tgp_black, by = "ID") %>% mutate(category = ifelse(ID %in% final_flipID, "flip", 
                                                                                    ifelse(ID %in% combine_removeID, "remove", ifelse(ID %in% notsig_all_keep, "not_sig_all_keep", 
                                                                                                                                      ifelse(ID %in% NA_list, "alt_freq_0", 
                                                                                                                                             ifelse(ID %in% notsig_all_flip, "not_sig_all_flip", "keep")))))) 
merge_AF_B$category <- factor(merge_AF_B$category, levels = c("keep", "alt_freq_0", "flip", "remove", "not_sig_all_keep", "not_sig_all_flip"))
ggplot(merge_AF_B %>% arrange(category) %>% filter(category != "alt_freq_0"), aes(x=as.numeric(ssns_altfreq), y=as.numeric(tgp_altfreq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('ssns+tgp merged allele freq: Black ancestry; sig level 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))

merge_AF_A = merge(afreq_ssns_a, tgp_asian, by = "ID") %>% mutate(category = ifelse(ID %in% final_flipID, "flip", 
                                                                                    ifelse(ID %in% combine_removeID, "remove", ifelse(ID %in% notsig_all_keep, "not_sig_all_keep", 
                                                                                                                                      ifelse(ID %in% NA_list, "alt_freq_0", 
                                                                                                                                             ifelse(ID %in% notsig_all_flip, "not_sig_all_flip", "keep")))))) 
merge_AF_A$category <- factor(merge_AF_A$category, levels = c("keep", "alt_freq_0", "flip", "remove", "not_sig_all", "not_sig_all_keep", "not_sig_all_flip"))
ggplot(merge_AF_A %>% arrange(category) %>% filter(category != "alt_freq_0"), aes(x=as.numeric(ssns_altfreq), y=as.numeric(tgp_altfreq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('ssns+tgp merged allele freq: South Asian ancestry; sig level 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))

merge_AF_W = merge(afreq_ssns_w, tgp_white, by = "ID") %>% mutate(category = ifelse(ID %in% final_flipID, "flip", 
                                                                                    ifelse(ID %in% combine_removeID, "remove", ifelse(ID %in% notsig_all_keep, "not_sig_all_keep", 
                                                                                                                                      ifelse(ID %in% NA_list, "alt_freq_0", 
                                                                                                                                             ifelse(ID %in% notsig_all_flip, "not_sig_all_flip", "keep")))))) 
merge_AF_W$category <- factor(merge_AF_W$category, levels = c("keep", "alt_freq_0", "flip", "remove", "not_sig_all", "not_sig_all_keep", "not_sig_all_flip"))
ggplot(merge_AF_W %>% arrange(category) %>% filter(category != "alt_freq_0"), aes(x=as.numeric(ssns_altfreq), y=as.numeric(tgp_altfreq), color = category)) + geom_point(size = 0.5) + 
  ggtitle('ssns+tgp merged allele freq: White ancestry; sig level 1e-10') + scale_x_continuous(name="SSNS") +
  scale_y_continuous(name="TGP") + scale_color_manual(values=c("#999999", "#56B4E9",  "darkgreen", "yellow", "red"))
table(merge_AF_B$category)
```
